<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <title>Rents Map</title>
        
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet"/>
        <link href="./css/rents-map.css" rel="stylesheet"/>
    </head>
    <body>
        <div id="app">
            <h1>Rent Affordability in the UK</h1>
            <div id="map">Click to zoom <br/></div>
            <div id="#map-controls">
                <ul id="map-key">
                    <li>&lt; 40%
                    <li class="map-key-color green"></li>
                    <li class="map-key-color yellow"></li>
                    <li class="map-key-color pale-orange"></li>
                    <li class="map-key-color dark-orange"></li>
                    <li class="map-key-color pale-red"></li>
                    <li class="map-key-color bright-red"></li>
                    <li>&lt; 90%</li>
                </ul>
                <ul id="selectors">
                    <li>
                        <label>
                            <input type="radio" name="group1" id="r1" value="1046.81">
                            National Living Wage
                        </label>
                    </li>
                    <li>
                        <label>
                            <input type="radio" name="group1" id="r2" value="1761.37" checked>
                            Median Wage
                        </label>
                    </li>
                    <li>
                        <label>
                        <input type="range" min="1000" max="3500" step="100" id="map_range"><br/>
                        £<span id="map_range_value"></span></label>
                    </li>
                </ul>
            </div>
        </div>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <!-- <script src="./js/rents-map.js" type="text/javscript"></script> -->
        <script>
            var z = 1761.37;
            var width = 355,
                height = 500,
                active = d3.select(null)
                tooltip = d3.select('.tooltip');

            var projection = d3.geoAlbers()
                .scale(2900)
                .translate([width/2,height/2])
                .center([1.75,54.7])
                .rotate([4.4,0])
                .parallels([50,60]);

            var zoom = d3.zoom()
                .on("zoom", zoomed);

            var initialTransform = d3.zoomIdentity
                .translate(0,0)
                .scale(1);

            var path = d3.geoPath()
                .projection(projection);

            var svg = d3.select('#map').append('svg')
                .attr('width', width)
                .attr('height', height);

            var g = svg.append('g');

            svg
                // .call(zoom) // allows free-scrolling
                .call(zoom.transform, initialTransform);

            width=320, height=480;

            d3.json('./data/Areas_topo_with_rents.json', function(error,uk){
                if (error) throw error;
            
                var color = d3.scaleThreshold()
                    .domain([z*0.4, z*0.5, z*0.6, z*0.7, z*0.8, z*0.9])
                    .range(['#80BC3A','#ffe081', '#ff872f', '#f1521a', '#f82d2d', '#fe0000']);

                g.selectAll('.area')
                    .data(topojson.feature(uk, uk.objects.Areas).features)
                .enter().append('path')
                    .attr('d', path)
                    .attr('class', 'area')
                    .attr('id', function(d,i){ return d.properties.name; })
                    .attr('data-rent', function(d) { return parseFloat(d.properties.average_rent); })
                    .attr('data-area', function(d) { return d.properties.name; })
                    .style('fill', function(d){ return color(parseFloat(d.properties.average_rent)); })
                    .on('click', clicked);

            });

            function clicked(d) {
                if (active.node() === this ) return reset();
                active.style('opacity', 1)
                active.classed("active", false);
                active = d3.select(this).classed("active", true);
                active.style('opacity', 0.5);
                d3.select('foreignObject').remove();
                var postcode = d.properties.name;
                var rent = d.properties.average_rent.toFixed(2);
                var text = 'Postcode Area: ' + postcode + ', Average Rent: £' + rent;

                var bounds = path.bounds(d),
                    dx = bounds[1][0] - bounds[0][0],
                    dy = bounds[1][1] - bounds[0][1],
                    x = (bounds[0][0] + bounds[1][0]) / 2,
                    y = (bounds[0][1] + bounds[1][1]) / 2,
                    scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
                    translate = [width / 2 - scale * x, height / 2 - scale * y];

                
                var transform = d3.zoomIdentity
                    .translate(translate[0], translate[1])
                    .scale(scale);

                svg.transition()
                    .duration(750)
                    .call(zoom.transform, transform);

                svg.append('foreignObject')
                    .attr('class', 'tooltip')
                    .attr('height', height)
                    .attr('width', width)
                    .attr('x', 10)
                    .attr('y', 420)
                    .append('xhtml:div')
                    .append('div')
                    .attr('class', 'tooltip')
                    .attr('height', height-20)
                    .attr('width', width-20)
                    .style('background-color', 'rgba(30,30,40,0.85)')
                    .append('p')
                    .style('color', 'rgba(225,225,215,1)')
                    .text(text);
                }

            var slider = document.getElementById('map_range');
            var box = document.getElementById('map_range_value');
            box.innerHTML = z;
            slider.value = z;
            var r1 = document.getElementById('r1');
            var r2 = document.getElementById('r2');
            r1.addEventListener("change", function(e){ box.innerHTML = e.target.value; slider.value = e.target.value; updateThreshold(e.target.value); });
            r2.addEventListener("change", function(e){ box.innerHTML = e.target.value; slider.value = e.target.value; updateThreshold(e.target.value); });
            slider.onchange = function() {
                if(r1.checked == true) { r1.checked = false; };
                if(r2.checked == true) { r2.checked = false; };
                z = this.value;
                box.innerHTML = z;
                color2 = d3.scaleThreshold()
                    .domain([z*0.4, z*0.5, z*0.6, z*0.7, z*0.8, z*0.9])
                    .range(['#80BC3A','#ffe081', '#ff872f', '#f1521a', '#f82d2d', '#fe0000']);

                svg.selectAll('.area').transition()
                    .style('fill', function(d){ return color2(parseFloat(d.properties.average_rent)); })
            }



            function reset() {
                active.style('opacity', 1);
                active.classed("active", false);
                active = d3.select(null);
                d3.select('foreignObject').remove();
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, initialTransform);
            }

            function zoomed() {
                var transform = d3.event.transform; 
                
                g.style("stroke-width", 1.5 / transform.k + "px");
                g.attr("transform", transform);
            }

            function updateThreshold(x) {
                color2 = d3.scaleThreshold()
                    .domain([x*0.4, x*0.5, x*0.6, x*0.7, x*0.8, x*0.9])
                    .range(['#80BC3A','#ffe081', '#ff872f', '#f1521a', '#f82d2d', '#fe0000']);

                svg.selectAll('.area').transition()
                    .style('fill', function(d){ return color2(parseFloat(d.properties.average_rent)); })
            }

            // If the drag behavior prevents the default click,
            // also stop propagation so we don’t click-to-zoom.
                function stopped() {
                    if (d3.event.defaultPrevented) d3.event.stopPropagation();
                }
        </script>
    </body>
</html>